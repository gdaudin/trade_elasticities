*Pour appendice 1 (coverage).do version of Sept 6: only part on constructing superbal sample used 
*to construct superbal sample & to rerun estimations for part 1 (graphs)
*Version Juin 2015 pour Guillaume et intégrer jusqu'à 2013
**This program was written in May 2013
*adapted to follow revision in Nov 2013
*this program computes sample of stable pairs (bal-superbal-square) in 1963-2009
*prepares all graphs for appendix 1 in paper on full-superbal sample coverage

*****************************
***set directory and matsize
*****************************
clear all
set matsize 800
set more off

*GD
*global dir "~/Documents/Recherche/OFCE Substitution Elasticities"
*cd "$dir"

*on econces1:
global dir "Y:\ELAST_NONLIN"
cd "$dir"


**1**create superbalanced sample for some subset of years: 
*pairs trading both ways in each year
capture program drop superbal
program superbal
**redef_full_pair_tot_trade file has total trade by pair redefined to have SUN, DEU, CSH
*use "$dir/Résultats/Première partie/Coverage/cov_per_year_pair.dta"
use cov_per_year_pair, clear

*`1' is starting year for the superbalanced sample: 1963 or 1970
*`2' is defined as a fct of `1' to drop unneeded years: 1962 or 1962-1969

local 2=`1'-1
local name tot_pair tot_uv
foreach n of local name {
	forvalues i=1962(1)`2' {
		drop if year==`i'
	}
} 

**define local 3 to store total nb of years for pair present in each year
local 3=2013-`1'+1
bys iso_d iso_o : generate test_rep=_N
gen id=.
replace id=0 if test_rep<`3'
replace id=1 if test_rep==`3'
tab id
rename test_rep nb_years
**There are 2712 stable pairs (trade in each year in 1963-2009) and 29112 unstable pairs 
**The median pair is present in the sample for 15 years, IQR is 6-31 years, with mean at 19.1

bys iso_o iso_d : keep if _n==1
drop year tot_pair

histogram nb_years, width(5) xtitle("Number of years") title("Pair presence in `1'-2013") fract 
graph export nb_years_pair_presence_`1'_13.eps, replace


*--------------------------------------------------------------------------------
**construct superbalanced sample defined from some year `1' until 2013**
**defined as the set of all pairs which trade both ways in each year of the sample


local source o d
local name RUS UKR UZB KAZ BLR AZE GEO TJK MDA KGZ LTU TKM ARM LVA EST
local germany FRG DDR
local center CZE SVK
foreach s of local source {
	foreach n of local name {
		replace iso_`s'="SUN" if iso_`s'=="`n'"
	}	
	foreach g of local germany {
		replace iso_`s'="DEU" if iso_`s'=="`g'"
	}	
	foreach c of local center {
		replace iso_`s'="CSH" if iso_`s'=="`c'"
	}	
}

collapse (max) id, by(iso_d iso_o)


keep if id==1
drop id
preserve
keep iso_o iso_d
save list_stable_`1'_13, replace
use list_stable_`1'_13, clear
rename iso_o partner
rename iso_d reporter
*switch the two sides
rename partner iso_d
rename reporter iso_o
save tmp_switch, replace
restore
joinby iso_d iso_o using tmp_switch, unmatched(none)

save superbal_`1'_13, replace
erase tmp_switch.dta
erase list_stable_`1'_13.dta
**create file for regressions:
use superbal_`1'_13, clear
keep iso_o iso_d
save superbal_list_`1', replace

end


*************
**use 1963 superbal sample to modify graphs in appendix of paper
*compare total trade for full sample; superbalanced sample; square sample
*1963-2009
*************
capture program drop cover
program cover
*use "$dir/Résultats/Première partie/Coverage/cov_per_year_pair.dta"
use cov_per_year_pair, clear
local source o d
local name RUS UKR UZB KAZ BLR AZE GEO TJK MDA KGZ LTU TKM ARM LVA EST
local germany FRG DDR
local center CZE SVK
foreach s of local source {
	foreach n of local name {
		replace iso_`s'="SUN" if iso_`s'=="`n'"
	}	
	foreach g of local germany {
		replace iso_`s'="DEU" if iso_`s'=="`g'"
	}	
	foreach c of local center {
		replace iso_`s'="CSH" if iso_`s'=="`c'"
	}	
}


preserve
joinby iso_o iso_d using superbal_list_1963, unmatched(none)
collapse (sum) tot_superbal=tot_pair, by(year)
replace tot_superbal=tot_superbal*10^(-9)
*initially trade measured in thsd usd, therefore scale is trillion
save tmp_tot_superbal, replace

restore
preserve
**use square list to keep square sample: either MYS or ISR 
*basically these two countries trade with everybody else, but not with each other
*for simplicity keep both
use sq_list_1963, clear
gen iso_o=iso_d
fillin iso_o iso_d
drop if iso_o==iso_d
drop id _fillin
save tmp_square, replace

restore
preserve
joinby iso_o iso_d using tmp_square, unmatched(none)
collapse (sum) tot_square=tot_pair, by(year)
replace tot_sq=tot_sq*10^(-9)
erase tmp_square.dta
joinby year using tmp_tot_superbal, unmatched(none)
erase tmp_tot_superbal.dta
save coverage, replace

restore
collapse (sum) tot_full=tot_pair, by(year)
replace tot_full=tot_full*10^(-9)
joinby year using coverage, unmatched(none)
save coverage, replace
**construct coverage comparison 


use coverage, clear
gen double cov_superbal_to_full=tot_superbal/tot_full
gen double cov_square_to_full=tot_sq/tot_full
drop if year==1962
twoway (connected cov_superbal_to_full year, ytitle("Share of total trade", axis(1)) ylabel(.2(.1).8, angle(horizontal) axis(1) nogrid) lcolor(dknavy) lwidth(medium) msymbol(point) mcolor(dknavy)) /*
*/ (connected cov_square_to_full year,  lcolor(red) lwidth(medium) msymbol(point) mcolor(red)) /*
*/(spike tot_full year, lcolor(blue) lpattern(shortdash) yaxis(2) ytitle("Trillions of USD", axis(2)) yscale(titlegap(medsmall) axis(2)) ylabel(0(2.5)15, angle(horizontal) grid glwidth(vthin) glcolor(bluishgray) axis(2))) , /*
*/title("Trade coverage: stable pairs")/* 
*/legend(label(1 "Superbalanced sample") label(2 "Square sample") label(3 "Trade in full sample [right scale]")) /*
*/ yscale(axis(2) range (0 15)) ylabel(0(3)15, axis(2)) yscale(axis(2) range (0 1)) ylabel(0(0.2)1, axis(1))

graph export trade_coverage_1963.eps, replace

end


******************************
**check using reciprocal trade
******************************
**how much of total annual trade covered by pairs
**which trade both ways in 1963(1970)
capture program drop recip
program recip
*use "$dir\GUILLAUME_DAUDIN\COMTRADE_Stata_data\SITC_Rev1_adv_query_2011\redef_full_pair_tot_trade", clear
use redef_full_pair_tot_trade, clear
keep iso_o iso_d tot_pair`1' 
drop if tot_pair`1'==. | tot_pair`1'==0
preserve
keep iso_o iso_d
save list_`2', replace
use list_`2', clear
rename iso_o partner
rename iso_d reporter
*switch the two sides
rename partner iso_d
rename reporter iso_o
save tmp_switch, replace
restore
joinby iso_d iso_o using tmp_switch, unmatched(none)
keep iso_o iso_d
save reciprocal`2', replace
erase tmp_switch.dta
*use "$dir\GUILLAUME_DAUDIN\COMTRADE_Stata_data\SITC_Rev1_adv_query_2011\redef_full_pair_tot_trade", clear
use redef_full_pair_tot_trade, clear
drop nb_years id tot_uv*
joinby iso_o iso_d using reciprocal`2', unmatched(none)
reshape long tot_pair, i(iso_o iso_d) j(year)
**save data on total annual trade in reciprocal sample
collapse (sum) recip_`1'=tot_pair,by(year)
replace recip_`1'=recip_`1'*10^(-9)
merge 1:1 year using coverage, update replace nogen norep
save coverage, replace
clear
end

*add data on annual reciprocal trade:
*previously constructed file contains reciprocal trade by year
*eg if we take pairs which trade both ways in a given year, how much that is out of total trade
capture program drop annual
program annual
*use "$dir\GUILLAUME_DAUDIN\COMTRADE_Stata_data\SITC_Rev1_adv_query_2011\recip_sample", clear
use recip_sample, clear
drop tot_uv
collapse (sum) recip_annual=tot_pair,by(year)
replace recip_annual=recip_annual*10^(-9)
merge 1:1 year using coverage, update replace nogen norep
save coverage, replace
***************************
**GRAPH FOR PAPER**RECIPROCAL TRADE**
use coverage, clear
gen double cov_recip63=recip_1963/tot_full
gen double cov_recip70=recip_1970/tot_full
gen double cov_recipannual=recip_annual/tot_full
drop if year<1963
twoway (connected cov_recip63 year, ytitle("Coverage reciprocal trade") ylabel(.4(.1)1, angle(horizontal) grid glwidth(vthin) glcolor(bluishgray)) lcolor(blue) lwidth(medium) msymbol(point) mcolor(blue)) /*
*/ (connected cov_recip70 year, lcolor(red) lwidth(medium) msymbol(point) mcolor(red)) /*
*/ (connected cov_recipannual year, lpattern(solid) lcolor(black) lwidth(medthick) msymbol(point) mcolor(black)), /*
*/title("Reciprocal trade share")/* 
*/legend(label(1 "Reciprocal 1963") label(2 "Reciprocal 1970") label(3 "Reciprocal annual"))
graph export recip_coverage_63_70.eps, replace
end



*RUN PROGRAMS:
superbal 1963
superbal 1970

*review square: revise code!
*square 1963
*square 1970
*this file can be run only after square 1963
*cover

recip 1963 63
recip 1970 70

annual
